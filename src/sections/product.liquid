{%- assign current_variant = product.selected_or_first_available_variant -%}
{%- assign variant = current_variant -%} {% comment %} Yotpo script needs this var {% endcomment %}
{%- assign featured_image = current_variant.featured_image | default: product.featured_image -%}

{% assign block = blank %}
{% for b in section.blocks %}
  {% if b.settings.product == product.handle %}
    {% assign block = b %}
    {% break %}
  {% endif %}
{% endfor %}

{% capture submit_button_contents %}
  <span data-add-to-cart-text>
    {% if current_variant.available %}
      {{ 'products.product.add_to_cart' | t }}              
    {% else %}
      {{ 'products.product.sold_out' | t }}
    {% endif %}
  </span>
  <span class="emdash"></span>
  <span data-product-price>
    {{ current_variant.price | money_without_trailing_zeros }}
  </span>
  <span class="currency">USD</span>
{% endcapture %}

{% capture background_video_html %}
  {% assign src = block.settings.product_background_video_file_url %}
  {% assign video_type = '' %}

  {% if src != blank %}
    {% if src contains '.mp4' %}  
      {% assign video_type = 'mp4' %} 
    {% elsif src contains '.og' %}  
      {% assign video_type = 'ogg' %} 
    {% elsif src contains '.avi' %} 
      {% assign video_type = 'avi' %} 
    {% elsif src contains '.webm' %}  
      {% assign video_type = 'webm' %}  
    {% endif %}  
  {% endif %}

  {% unless video_type == '' %}
    <video autoplay loop muted> 
      <source src="{{ src }}" type="video/{{ video_type }}" />  
    </video>
  {% endunless %}
{% endcapture %}

<div data-section-id="{{ section.id }}" data-section-type="product" itemscope itemtype="http://schema.org/Product">
  <meta itemprop="name" content="{{ product.title }}{% unless product.has_only_default_variant %} - {{ current_variant.title }}{% endunless %}">
  <meta itemprop="url" content="{{ shop.url }}{{ current_variant.url }}">
  <meta itemprop="brand" content="{{ product.vendor }}">
  <meta itemprop="image" content="{{ featured_image | img_url: '600x600' }}">
  <meta itemprop="description" content="{{ product.description | strip_html | escape }}">
  <meta itemprop="priceCurrency" content="{{ shop.currency }}">
  <meta itemprop="price" content="{{ current_variant.price | divided_by: 100.00 }}">
  <link itemprop="availability" href="http://schema.org/{% if current_variant.available %}InStock{% else %}OutOfStock{% endif %}">

  <form action="/cart/add" method="post" enctype="multipart/form-data" data-product-form>

    <!-- Product Grids -->
    <div class="product-grids drawer-shifter">
      <div class="product-grid">
        <div class="product-grid__col">
          <div class="product-detail__child product-detail__child--gallery">
            <div class="product-detail-gallery">
              <div class="gallery-image gallery-image--background">
                <img src="{{ block.settings.product_background_image | img_url: '1600x' }}" />
                {{ background_video_html }}
              </div>
              <div class="gallery-image gallery-image--foreground">
                <img src="{{ block.settings.product_image | img_url: '1600x' }}" />
              </div>  
            </div>            
          </div>
        </div>

        <div class="product-grid__col" style="height: auto;">
          <div class="product-detail__child product-detail__child--form">
            {% render 'product-detail-form',
                       product: product,
                       current_variant: current_variant,
                       block: block,
                       submit_button_contents: submit_button_contents
            %}
          </div>
          <div style="background-color: #FAFAD6">
            <div class="aplos-4side-container">
              <h2>How To Enjoy</h2>
              <div class="rte" style="max-width: 29em; margin-bottom: 60px;">
                <p clas="p1">
                  We designed Wild Citrus to replicate the ritual of drinking a spirit. It can be enjoyed neat, on the rocks, or mixed as a cocktail.  We use exceptional ingredients formulated to enhance the immediate pleasure of taste, and the slow pleasures of the mind that follow.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="product-grid">
        <div class="product-grid__col">
          <div class="product-detail__child product-detail__child--gallery" style="background-color: black;">
            <img src="{{ 'test-drink.jpg' | asset_url }}" style="height: 100%; width: 100%; object-fit: cover" />
          </div>
        </div>
        <div class="product-grid__col">
          <div class="product-detail__child" style="background-color: #FAFAD6">
            <div class="aplos-4side-container">
              <h2>Recipes</h2>
              <div class="rte" style="max-width: 29em; margin-bottom: 60px;">
                {% for i in (1..3) %}
                  <p>Cartel rebar futurity kanji motion sub-orbital disposable narrative franchise singularity human man soul-delay. Monofilament silent geodesic shrine euro-pop systemic smart-corporation franchise Kowloon skyscraper DIY saturation point Shibuya. Drone concrete render-farm Shibuya sentient human franchise dead tower. Numinous construct papier-mache physical systemic semiotics plastic tiger-team woman Tokyo engine nodality. Into receding cartel bicycle monofilament soul-delay refrigerator shrine warehouse kanji Tokyo decay. Bridge futurity dolphin courier San Francisco tanto sprawl drone shanty town warehouse physical-ware soul-delay office cyber-woman sunglasses. Systema augmented reality computer-ware realism boat corporation chrome marketing ablative camera. </p>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="product-grid">
        <div class="product-grid__col">
          <div class="product-detail__child product-detail__child--gallery">
            <img src="{{ 'test-accent-1.jpg' | asset_url }}" style="height: 100%; width: 100%; object-fit: cover" />
          </div>
        </div>
        <div class="product-grid__col">
          <div class="product-detail__child" style="background-color: #FAFAD6">
            <div class="aplos-4side-container">
              <h2>Hemp with Higher Standards</h2>

              {% for i in (1..3) %}
                <div style="display: flex; margin: 50px 0; padding: 50px 0; {% unless i == 1 %}border-top: 1px solid black{% endunless %}">
                  <div class="p2" style="padding-right: 7vw; flex: 0.3;">
                    0{{ i }}.<br />
                    {% if i == 1 %}
                      Sourcing
                    {% elsif i == 2 %}
                      3rd Party Testing
                    {% else %}
                      Efficacy
                    {% endif %}
                  </div>
                  <div class="rte" style="flex: 1; margin-bottom: 0;">
                    {% if i == 1 %}
                      We are committed to ethical sourcing and use only the highest quality ingredients to formulate our product.
                      Our sun-grown, organic hemp is sourced from a bio-dynamic, regenerative farm in New York’s Hudson Valley.
                    {% elsif i == 2 %}
                      To ensure the purity and potency of the broad-spectrum hemp we use in every bottle of Aplós, we have developed rigorous, third-party testing protocols at essential stages throughout the production process: after extraction from the plant, at nano-emulsification, and at final bottling.
                    {% else %}
                      We use an organic nano-emulsification technology to convert the hemp extract oil into smaller, water-soluble particles to allow your body to absorb the active cannabinoids faster and more efficiently, resulting in a calming and uplifting effect with a rapid onset within 5-15 minutes, and shorter effect duration of 1-2 hours.
This provides more control and a more predictable experience.
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>      
      <div class="bg-butter-gray" style="padding: 50px 0;">
        <div class="aplos-4side-container">
          <div class="yotpo yotpo-main-widget" data-product-id="{{ product.id }}" data-name="{{ product.title | escape }}" data-url="{{ shop.url }}{{ product.url }}" data-image-url="{{ product.featured_image | product_img_url: 'large' |replace: '?', '%3F' | replace: '&','%26'}}" data-price="{{ variant.price | money_without_currency }}"
          data-currency=“{{ shop.currency }}” data-description=“{{ product.description | escape }}“>
          {%- assign yotpo_offload_content = shop.metafields.yotpo.yotpo_offload_content %}
            {%- assign time_now = 'now' | date: '%s' %}
            {%- assign yotpo_live_time = shop.metafields.yotpo.yotpo_live | date: '%s' %}
            {%- assign diff_seconds_from_live = time_now | minus: yotpo_live_time %}
            {%- assign yotpo_main_widget_last_updated = product.metafields.yotpo.main_widget_update_time | date: '%s' %}
            {%- assign diff_seconds_from_last_main_widget_update = time_now | minus: yotpo_main_widget_last_updated %}
            {%- if yotpo_live_time and diff_seconds_from_live < 86400 or yotpo_main_widget_last_updated and diff_seconds_from_last_main_widget_update < 86400 -%}
              {%- assign yotpo_main_widget_obsolete = false %}
            {%- else %}
              {%- assign yotpo_main_widget_obsolete = true %}
            {%- endif %}
            {%- if yotpo_offload_content == 'yes' and yotpo_main_widget_obsolete != true -%}
              {%- for field in product.metafields.yotpo_reviews -%}
                {{ field | last }}
              {%- endfor -%}
            {%- endif %}
          </div>          
        </div>
      </div>
    </div>
    <!-- END Product Grid -->

    <!-- Producct Mobile-->
    <div class="product-mobile drawer-shifter">
      <div class="product-mobile__imagery">
        <div class="product-mobile__imagery-bg">
          <img src="{{ block.settings.product_background_image | img_url: '800x' }}" />
          {{ background_video_html }}
        </div>
        <div class="product-mobile__imagery-fg">
          <img src="{{ block.settings.product_image | img_url: '800x' }}" />
        </div>
        <div class="product-mobile__imagery-cover"></div>
      </div>
      <div class="product-mobile__titles">
        <div class="h1" style="margin: 0; font-size: 36px;">{{ product.title }}</div>

        {% if block.settings.subtitle != blank %}
          <div class="p2" style="margin-top: 1.1rem;">
            {{ block.settings.subtitle }}
          </div>
        {% endif %}
      </div>
    </div>
    <!-- END Product Mobile-->

    <!-- Story Popup -->
    {% render 'story-popup',
               product: product
               block: block
    %}

    <!-- Transaction Bar -->
    {% render 'transaction-bar'
               product: product,
               current_variant: current_variant,
               subtitle: block.settings.subtitle,
               submit_button_contents: submit_button_contents
    %}

    <!-- Bare form elements, hidden for JS enabled browsers -->
    <!-- Is this where itemprop="offers" is supposed to go? -->
    <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
      <select name="id" class="no-js" data-product-select>
        {% for variant in product.variants %}
          <option
            {% if variant == current_variant %}selected="selected"{% endif %}
            {% unless variant.available %}disabled="disabled"{% endunless %}
            value="{{ variant.id }}">
              {{ variant.title }}
          </option>
        {% endfor %}
      </select>

      <input type="number" name="quantity" value="1" class="no-js" data-product-quantity>     
    </div>   

    <script type="application/json" data-product-json>
      {% render 'product-json', product: product %}
    </script>
  </form>
</div>

{% schema %}
  {
    "name": "Product Page",
    "settings": [],
    "blocks": [
      {
        "type": "product_info",
        "name": "Product Info",
        "settings": [
          {
            "type": "product",
            "id": "product",
            "label": "Product",
            "info": "The settings below with only display for the product selected here"
          },
          {
            "type": "richtext",
            "id": "subtitle",
            "label": "Subtitle"
          },
          {
            "type": "textarea",
            "id": "subtitle_mobile",
            "label": "Subtitle (Mobile)",
            "info": "Displays inside the popup card."
          },          
          {
            "type": "header",
            "content": "Imagery"
          },
          {
            "type": "image_picker",
            "id": "product_image",
            "label": "Product Image"
          },
          {
            "type": "image_picker",
            "id": "product_background_image",
            "label": "Product Background Image"
          },
          { 
            "type": "url",  
            "id": "product_background_video_file_url",  
            "label": "Product Background Video File URL",  
            "info": "Accepted file formats: mp4, ogg, avi, webm"  
          },
          {
            "type": "header",
            "content": "Additional Details",
            "info": "These details display as an expandable list"
          },
          {
            "type": "text",
            "id": "detail_title_1",
            "label": "Detail #1 Title"
          },
          {
            "type": "richtext",
            "id": "detail_content_1",
            "label": "Detail #1 Content"
          },
          {
            "type": "text",
            "id": "detail_title_2",
            "label": "Detail #2 Title"
          },
          {
            "type": "richtext",
            "id": "detail_content_2",
            "label": "Detail #2 Content"
          },
          {
            "type": "text",
            "id": "detail_title_3",
            "label": "Detail #3 Title"
          },
          {
            "type": "richtext",
            "id": "detail_content_3",
            "label": "Detail #3 Content"
          }
        ]
      }
    ]
  }
{% endschema %}
